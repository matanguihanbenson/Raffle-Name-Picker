<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Raffle Name Picker</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body class="flex items-center justify-center h-screen p-0 m-0">
    <div class="w-1/2">
      <h1>Raffle Name Picker</h1>
      <br>
      <div class="h-[300px] relative text-center">
        <div class="absolute w-full left-0 -top-3 text-center">
          <strong class="w-1/2 bg-red-600 p-2">The winner is:</strong>
        </div>
        
        <div class="winner bg-white p-10 " id="winner">
          
          
          <div class="flicker" id="flicker"></div>
        </div>
        
      </div>
      <div>
        <button id="pickWinnerButton" class="text-white">Pick a Winner</button>
        <button id="resetButton" class="text-white ml-2">Reset Winners</button>
      </div>

      
    </div>

    <script>
      const names = []; // This will store the names from the server

      // Fetch names from the server when the page loads
      fetch("/pick-winner?get-names=true")
        .then((response) => response.json())
        .then((data) => {
          // Store the list of names (including other details)
          names.push(...data.names);
          console.log("Names loaded:", names);
        })
        .catch((error) => console.error("Error fetching names:", error));

      // Function to simulate matrix-style flickering
      function startFlickering() {
        const flickerElement = document.getElementById("flicker");
        let intervalId;

        // Start flickering random names every 100ms
        intervalId = setInterval(() => {
          const randomName = names[Math.floor(Math.random() * names.length)];
          flickerElement.innerHTML = `<span>${randomName.firstName} ${randomName.lastName}</span>`;
        }, 100);

        // Stop flickering after 3 seconds and display the winner
        setTimeout(() => {
          clearInterval(intervalId);

          // Fetch the winner from the server
          fetch("/pick-winner")
            .then((response) => response.json())
            .then((data) => {
              if (data.message === "All participants have already won.") {
                // Display the "All participants have already won" message
                document.getElementById("winner").innerHTML =
                  "<strong>All participants have already won.</strong>";
                document.getElementById("flicker").style.display = "none";
              } else {
                const finalWinner = data.winner;
                console.log("Winner picked:", finalWinner);
                // Display the winner's information
                document.getElementById("winner").innerHTML = `
                                
<h1 class="text-black">${finalWinner["LAST NAME"]}, ${finalWinner["FIRST NAME"]} ${finalWinner["MIDDLE INITIAL"]}.</h1>
          <h2 class="text-xl">${finalWinner["SCHOOL"]}</h2>
          <h3 class="text-lg">${finalWinner["ADDRESS"]}</h3>                                
                            `;

                // Hide the flickering element after the winner is displayed
                document.getElementById("flicker").style.display = "none";
              }
            })
            .catch((error) => console.error("Error fetching winner:", error));
        }, 3000);
      }

      // Button event listener to start the selection process
      document
        .getElementById("pickWinnerButton")
        .addEventListener("click", () => {
          document.getElementById("winner").textContent = ""; // Clear previous winner
          document.getElementById("flicker").style.display = "block"; // Show the flickering animation
          startFlickering();
        });

      document
        .getElementById("resetButton")
        .addEventListener("click", function () {
          fetch("/reset-winners", {
            method: "POST",
          })
            .then((response) => {
              if (!response.ok) {
                return response.text().then((text) => {
                  throw new Error(text);
                });
              }
              return response.json();
            })
            .then((data) => {
              if (data.success) {
                alert("Winners have been reset!");
              } else {
                alert("Something went wrong. Please try again.");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Something went wrong. Please try again.");
            });
        });
    </script>
  </body>
</html>
